<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Worker 细致测试工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(30deg);
        }
        
        h1 {
            font-size: 36px;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
        }
        
        .subtitle {
            font-size: 18px;
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }
        
        .content {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
        }
        
        .card {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .card::after {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.05) 0%, rgba(0,0,0,0) 100%);
            border-radius: 0 0 0 100%;
        }
        
        .card h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 28px;
            position: relative;
            z-index: 2;
        }
        
        .card h2 i {
            font-size: 32px;
            color: #3498db;
        }
        
        .test-steps {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }
        
        .test-step {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
            border-left: 4px solid #3498db;
        }
        
        .test-step.completed {
            border-left-color: #2ecc71;
        }
        
        .test-step.failed {
            border-left-color: #e74c3c;
        }
        
        .test-step.running {
            border-left-color: #f39c12;
        }
        
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .step-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .step-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-pending {
            background: rgba(52, 152, 219, 0.15);
            color: #3498db;
        }
        
        .status-completed {
            background: rgba(46, 204, 113, 0.15);
            color: #27ae60;
        }
        
        .status-failed {
            background: rgba(231, 76, 60, 0.15);
            color: #c0392b;
        }
        
        .status-running {
            background: rgba(243, 156, 18, 0.15);
            color: #d35400;
        }
        
        .step-details {
            background: #f1f8ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .step-action {
            margin-top: 15px;
            display: flex;
            justify-content: flex-end;
        }
        
        .btn {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn-fix {
            background: #2ecc71;
            box-shadow: 0 3px 10px rgba(46, 204, 113, 0.3);
        }
        
        .btn-fix:hover {
            background: #27ae60;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }
        
        .btn-retry {
            background: #f39c12;
            box-shadow: 0 3px 10px rgba(243, 156, 18, 0.3);
        }
        
        .btn-retry:hover {
            background: #d35400;
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .test-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        
        .console {
            background: #1a252f;
            color: #ecf0f1;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            height: 400px;
            overflow-y: auto;
            line-height: 1.6;
            font-size: 14px;
        }
        
        .console-title {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            color: #3498db;
            font-weight: 600;
            font-size: 18px;
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding-left: 15px;
            border-left: 3px solid #3498db;
        }
        
        .log-entry.success {
            border-left-color: #2ecc71;
            color: #2ecc71;
        }
        
        .log-entry.error {
            border-left-color: #e74c3c;
            color: #e74c3c;
        }
        
        .log-entry.warning {
            border-left-color: #f39c12;
            color: #f39c12;
        }
        
        .log-entry.info {
            border-left-color: #3498db;
            color: #3498db;
        }
        
        .cache-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .info-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .info-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
        }
        
        .info-item {
            margin: 10px 0;
            padding-bottom: 10px;
            border-bottom: 1px dashed #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-value {
            font-weight: 600;
        }
        
        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #3498db;
            border-radius: 4px;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .offline-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            margin-right: 5px;
        }
        
        .online-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #2ecc71;
            margin-right: 5px;
        }
        
        .sw-diagram {
            margin-top: 20px;
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .sw-diagram img {
            max-width: 100%;
            height: auto;
        }
        
        .diagram-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            background: #2c3e50;
            color: #ecf0f1;
            font-size: 16px;
        }
        
        @media (max-width: 900px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 28px;
            }
            
            .card h2 {
                font-size: 24px;
            }
            
            .step-title {
                font-size: 18px;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-tasks"></i> Service Worker 细致测试工具</h1>
            <p class="subtitle">全面测试 Service Worker 的安装、缓存、更新和离线功能</p>
        </header>
        
        <div class="content">
            <div>
                <div class="card">
                    <h2><i class="fas fa-vial"></i> 测试步骤</h2>
                    <p>按照以下步骤细致测试 Service Worker 的各个方面：</p>
                    
                    <div class="test-steps">
                        <!-- 测试步骤将由JS动态生成 -->
                    </div>
                    
                    <div class="test-controls">
                        <button id="startTestBtn" class="btn btn-fix">
                            <i class="fas fa-play"></i> 开始全部测试
                        </button>
                        <button id="resetTestBtn" class="btn">
                            <i class="fas fa-redo"></i> 重置测试
                        </button>
                        <button id="clearCacheBtn" class="btn btn-retry">
                            <i class="fas fa-trash-alt"></i> 清除缓存
                        </button>
                        <button id="simulateOfflineBtn" class="btn">
                            <i class="fas fa-wifi"></i> 模拟离线
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h2><i class="fas fa-terminal"></i> 控制台日志</h2>
                    <div class="console">
                        <div class="console-title">
                            <span><i class="fas fa-code"></i> Service Worker 操作日志</span>
                            <button id="clearLogsBtn" class="btn btn-small">
                                <i class="fas fa-broom"></i> 清除日志
                            </button>
                        </div>
                        <div id="logContainer"></div>
                    </div>
                </div>
            </div>
            
            <div>
                <div class="card">
                    <h2><i class="fas fa-info-circle"></i> 缓存状态</h2>
                    
                    <div class="cache-info">
                        <div class="info-card">
                            <h3><i class="fas fa-microchip"></i> Service Worker 状态</h3>
                            <div class="info-item">
                                <span>注册状态:</span>
                                <span id="swStatus" class="info-value">未注册</span>
                            </div>
                            <div class="info-item">
                                <span>作用域:</span>
                                <span id="swScope" class="info-value">-</span>
                            </div>
                            <div class="info-item">
                                <span>当前状态:</span>
                                <span id="swState" class="info-value">-</span>
                            </div>
                        </div>
                        
                        <div class="info-card">
                            <h3><i class="fas fa-database"></i> 缓存信息</h3>
                            <div class="info-item">
                                <span>缓存名称:</span>
                                <span id="cacheName" class="info-value">-</span>
                            </div>
                            <div class="info-item">
                                <span>缓存大小:</span>
                                <span id="cacheSize" class="info-value">0 KB</span>
                            </div>
                            <div class="info-item">
                                <span>缓存文件数:</span>
                                <span id="cacheCount" class="info-value">0</span>
                            </div>
                        </div>
                        
                        <div class="info-card">
                            <h3><i class="fas fa-network-wired"></i> 网络状态</h3>
                            <div class="info-item">
                                <span>当前状态:</span>
                                <span id="networkStatus" class="info-value">
                                    <span class="online-indicator"></span> 在线
                                </span>
                            </div>
                            <div class="info-item">
                                <span>最后更新:</span>
                                <span id="lastUpdate" class="info-value">-</span>
                            </div>
                            <div class="info-item">
                                <span>离线支持:</span>
                                <span id="offlineSupport" class="info-value">未测试</span>
                            </div>
                        </div>
                        
                        <div class="info-card">
                            <h3><i class="fas fa-sync-alt"></i> 更新状态</h3>
                            <div class="info-item">
                                <span>当前版本:</span>
                                <span id="currentVersion" class="info-value">v1.0.0</span>
                            </div>
                            <div class="info-item">
                                <span>更新检查:</span>
                                <span id="updateStatus" class="info-value">未检查</span>
                            </div>
                            <div class="info-item">
                                <span>更新进度:</span>
                                <span id="updateProgress" class="info-value">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="progressFill" class="progress-fill"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sw-diagram">
                        <div class="diagram-title">Service Worker 生命周期</div>
                        <div style="display: flex; justify-content: center; align-items: center; height: 200px; background: #f8f9ff; border-radius: 8px;">
                            <div style="font-size: 16px; color: #666; text-align: center; padding: 20px;">
                                <i class="fas fa-diagram-project" style="font-size: 48px; color: #3498db; margin-bottom: 15px;"></i>
                                <p>Service Worker 工作流程图</p>
                                <p style="font-size: 14px; margin-top: 10px;">注册 → 安装 → 激活 → 控制页面</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2023 Service Worker 测试工具 | 提供完全自包含的解决方案</p>
            <p>遇到问题？参考 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API" 
                style="color: #3498db; text-decoration: none;" target="_blank">MDN Service Worker 文档</a></p>
        </footer>
    </div>
    
    <script>
        // DOM元素
        const startTestBtn = document.getElementById('startTestBtn');
        const resetTestBtn = document.getElementById('resetTestBtn');
        const clearCacheBtn = document.getElementById('clearCacheBtn');
        const simulateOfflineBtn = document.getElementById('simulateOfflineBtn');
        const clearLogsBtn = document.getElementById('clearLogsBtn');
        const logContainer = document.getElementById('logContainer');
        const testStepsContainer = document.querySelector('.test-steps');
        
        // 状态元素
        const swStatus = document.getElementById('swStatus');
        const swScope = document.getElementById('swScope');
        const swState = document.getElementById('swState');
        const cacheName = document.getElementById('cacheName');
        const cacheSize = document.getElementById('cacheSize');
        const cacheCount = document.getElementById('cacheCount');
        const networkStatus = document.getElementById('networkStatus');
        const lastUpdate = document.getElementById('lastUpdate');
        const offlineSupport = document.getElementById('offlineSupport');
        const currentVersion = document.getElementById('currentVersion');
        const updateStatus = document.getElementById('updateStatus');
        const updateProgress = document.getElementById('updateProgress');
        const progressFill = document.getElementById('progressFill');
        
        // Service Worker 配置
        const CACHE_NAME = 'sw-test-cache-v1';
        const SW_VERSION = 'v1.0.0';
        const urlsToCache = [
            location.href,
            'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css'
        ];
        
        // 测试步骤数据
        const testSteps = [
            {
                id: 'browser-support',
                title: '浏览器支持检测',
                description: '检查当前浏览器是否支持Service Worker API',
                action: testBrowserSupport
            },
            {
                id: 'register-sw',
                title: '注册Service Worker',
                description: '尝试注册Service Worker并检查注册状态',
                action: registerServiceWorker
            },
            {
                id: 'install-event',
                title: '安装事件测试',
                description: '验证Service Worker安装事件是否触发',
                action: testInstallEvent
            },
            {
                id: 'cache-resources',
                title: '资源缓存测试',
                description: '检查指定资源是否被成功缓存',
                action: testCacheResources
            },
            {
                id: 'activate-event',
                title: '激活事件测试',
                description: '验证Service Worker激活事件是否触发',
                action: testActivateEvent
            },
            {
                id: 'fetch-event',
                title: '请求拦截测试',
                description: '测试Service Worker是否能正确拦截和处理请求',
                action: testFetchEvent
            },
            {
                id: 'offline-test',
                title: '离线功能测试',
                description: '模拟离线环境，测试缓存资源是否可用',
                action: testOfflineFunctionality
            },
            {
                id: 'update-test',
                title: '更新机制测试',
                description: '测试Service Worker更新流程',
                action: testUpdateMechanism
            },
            {
                id: 'cache-clear',
                title: '缓存清除测试',
                description: '测试清除缓存功能是否正常工作',
                action: testCacheClear
            }
        ];
        
        // 测试状态
        let currentStep = 0;
        let isTesting = false;
        let isOfflineSimulated = false;
        let registration = null;
        
        // 添加日志
        function addLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // 更新UI状态
        function updateUI() {
            // 更新网络状态
            const networkEl = networkStatus.querySelector('.online-indicator, .offline-indicator');
            if (isOfflineSimulated || !navigator.onLine) {
                networkStatus.innerHTML = '<span class="offline-indicator"></span> 离线';
                networkStatus.style.color = '#e74c3c';
            } else {
                networkStatus.innerHTML = '<span class="online-indicator"></span> 在线';
                networkStatus.style.color = '#27ae60';
            }
            
            // 更新最后更新时间
            lastUpdate.textContent = new Date().toLocaleTimeString();
        }
        
        // 初始化测试步骤
        function initTestSteps() {
            testStepsContainer.innerHTML = '';
            
            testSteps.forEach((step, index) => {
                const stepEl = document.createElement('div');
                stepEl.className = 'test-step';
                stepEl.id = `step-${step.id}`;
                stepEl.innerHTML = `
                    <div class="step-header">
                        <div class="step-title">${index + 1}. ${step.title}</div>
                        <div class="step-status status-pending">待测试</div>
                    </div>
                    <div class="step-description">${step.description}</div>
                    <div class="step-details" id="details-${step.id}">等待测试中...</div>
                    <div class="step-action">
                        <button class="btn btn-small" onclick="runSingleTest(${index})">执行测试</button>
                    </div>
                `;
                testStepsContainer.appendChild(stepEl);
            });
        }
        
        // 更新步骤状态
        function updateStepStatus(stepIndex, status, details = '') {
            const step = testSteps[stepIndex];
            const stepEl = document.getElementById(`step-${step.id}`);
            const statusEl = stepEl.querySelector('.step-status');
            const detailsEl = stepEl.querySelector('.step-details');
            
            // 移除现有状态类
            stepEl.classList.remove('completed', 'failed', 'running');
            statusEl.classList.remove(
                'status-pending', 
                'status-completed', 
                'status-failed', 
                'status-running'
            );
            
            // 添加新状态
            switch (status) {
                case 'running':
                    stepEl.classList.add('running');
                    statusEl.classList.add('status-running');
                    statusEl.textContent = '测试中...';
                    break;
                case 'completed':
                    stepEl.classList.add('completed');
                    statusEl.classList.add('status-completed');
                    statusEl.textContent = '通过';
                    break;
                case 'failed':
                    stepEl.classList.add('failed');
                    statusEl.classList.add('status-failed');
                    statusEl.textContent = '失败';
                    break;
                default:
                    stepEl.classList.remove('running');
                    statusEl.classList.add('status-pending');
                    statusEl.textContent = '待测试';
            }
            
            if (details) {
                detailsEl.textContent = details;
            }
        }
        
        // 测试浏览器支持
        function testBrowserSupport() {
            return new Promise((resolve) => {
                updateStepStatus(0, 'running');
                addLog('开始浏览器支持测试...', 'info');
                
                setTimeout(() => {
                    if ('serviceWorker' in navigator) {
                        addLog('浏览器支持Service Worker API', 'success');
                        updateStepStatus(0, 'completed', '浏览器支持Service Worker API');
                        resolve(true);
                    } else {
                        addLog('浏览器不支持Service Worker API', 'error');
                        updateStepStatus(0, 'failed', '浏览器不支持Service Worker API');
                        resolve(false);
                    }
                }, 1000);
            });
        }
        
        // 注册Service Worker
        function registerServiceWorker() {
            return new Promise((resolve) => {
                updateStepStatus(1, 'running');
                addLog('开始注册Service Worker...', 'info');
                
                // 创建Service Worker脚本
                const swScript = `
                    const CACHE_NAME = '${CACHE_NAME}';
                    const urlsToCache = ${JSON.stringify(urlsToCache)};
                    
                    // 安装Service Worker并缓存资源
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => {
                                    console.log('[Service Worker] 缓存核心资源');
                                    return cache.addAll(urlsToCache);
                                })
                                .then(() => {
                                    console.log('[Service Worker] 所有资源已缓存');
                                    return self.skipWaiting();
                                })
                        );
                    });
                    
                    // 激活时清理旧缓存
                    self.addEventListener('activate', event => {
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.filter(name => name !== CACHE_NAME)
                                        .map(name => caches.delete(name))
                                );
                            })
                        );
                        console.log('[Service Worker] 已激活');
                        clients.claim();
                    });
                    
                    // 拦截网络请求
                    self.addEventListener('fetch', event => {
                        // 对于同源请求，使用缓存优先策略
                        if (event.request.url.startsWith(location.origin)) {
                            event.respondWith(
                                caches.match(event.request)
                                    .then(response => {
                                        return response || fetch(event.request);
                                    })
                            );
                        }
                        // 对于字体资源，也使用缓存优先
                        else if (event.request.url.includes('fontawesome') || 
                                 event.request.url.includes('fonts.gstatic')) {
                            event.respondWith(
                                caches.match(event.request)
                                    .then(response => {
                                        return response || fetch(event.request)
                                            .then(networkResponse => {
                                                // 将新资源加入缓存
                                                caches.open(CACHE_NAME)
                                                    .then(cache => {
                                                        cache.put(event.request, networkResponse.clone());
                                                    });
                                                return networkResponse;
                                            });
                                    })
                            );
                        }
                        // 其他请求直接访问网络
                        else {
                            event.respondWith(fetch(event.request));
                        }
                    });
                    
                    // 监听来自主线程的消息
                    self.addEventListener('message', event => {
                        if (event.data.type === 'GET_CACHE_INFO') {
                            caches.open(CACHE_NAME).then(cache => {
                                cache.keys().then(keys => {
                                    event.ports[0].postMessage({
                                        count: keys.length,
                                        name: CACHE_NAME
                                    });
                                });
                            });
                        }
                    });
                `;
                
                // 创建Blob URL并注册Service Worker
                const blob = new Blob([swScript], {type: 'application/javascript'});
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(reg => {
                        registration = reg;
                        addLog(`Service Worker 注册成功! 作用域: ${reg.scope}`, 'success');
                        updateStepStatus(1, 'completed', `注册成功! 作用域: ${reg.scope}`);
                        
                        // 更新UI状态
                        swStatus.textContent = '已注册';
                        swStatus.style.color = '#27ae60';
                        swScope.textContent = reg.scope;
                        swState.textContent = '安装中...';
                        cacheName.textContent = CACHE_NAME;
                        
                        // 监听状态变化
                        reg.installing.addEventListener('statechange', () => {
                            swState.textContent = reg.installing.state;
                        });
                        
                        resolve(true);
                    })
                    .catch(error => {
                        addLog(`Service Worker 注册失败: ${error.message}`, 'error');
                        updateStepStatus(1, 'failed', `注册失败: ${error.message}`);
                        
                        // 更新UI状态
                        swStatus.textContent = '未注册';
                        swStatus.style.color = '#e74c3c';
                        
                        resolve(false);
                    });
            });
        }
        
        // 测试安装事件
        function testInstallEvent() {
            return new Promise((resolve) => {
                updateStepStatus(2, 'running');
                addLog('测试安装事件...', 'info');
                
                if (!registration) {
                    addLog('Service Worker未注册，无法测试安装事件', 'error');
                    updateStepStatus(2, 'failed', 'Service Worker未注册');
                    resolve(false);
                    return;
                }
                
                // 监听安装事件
                registration.installing.addEventListener('statechange', () => {
                    if (registration.installing.state === 'installed') {
                        addLog('Service Worker安装成功!', 'success');
                        updateStepStatus(2, 'completed', '安装事件成功触发');
                        swState.textContent = '已安装';
                        resolve(true);
                    }
                });
                
                // 设置超时以防安装失败
                setTimeout(() => {
                    if (registration.installing.state !== 'installed') {
                        addLog('Service Worker安装超时', 'error');
                        updateStepStatus(2, 'failed', '安装事件未触发');
                        resolve(false);
                    }
                }, 5000);
            });
        }
        
        // 测试资源缓存
        function testCacheResources() {
            return new Promise((resolve) => {
                updateStepStatus(3, 'running');
                addLog('测试资源缓存...', 'info');
                
                // 模拟缓存进度
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 10;
                    progressFill.style.width = `${progress}%`;
                    updateProgress.textContent = `${progress}%`;
                    if (progress >= 100) clearInterval(interval);
                }, 200);
                
                // 检查缓存
                setTimeout(() => {
                    caches.open(CACHE_NAME)
                        .then(cache => {
                            return cache.keys();
                        })
                        .then(keys => {
                            const cachedCount = keys.length;
                            cacheCount.textContent = cachedCount;
                            
                            if (cachedCount > 0) {
                                addLog(`成功缓存 ${cachedCount} 个资源`, 'success');
                                updateStepStatus(3, 'completed', `已缓存 ${cachedCount} 个资源`);
                                
                                // 计算缓存大小
                                let totalSize = 0;
                                Promise.all(keys.map(key => {
                                    return caches.match(key).then(response => {
                                        if (response) {
                                            return response.blob().then(blob => {
                                                return blob.size;
                                            });
                                        }
                                        return 0;
                                    });
                                })).then(sizes => {
                                    totalSize = sizes.reduce((sum, size) => sum + size, 0);
                                    const sizeKB = (totalSize / 1024).toFixed(2);
                                    cacheSize.textContent = `${sizeKB} KB`;
                                });
                                
                                resolve(true);
                            } else {
                                addLog('没有找到缓存资源', 'error');
                                updateStepStatus(3, 'failed', '未找到缓存资源');
                                resolve(false);
                            }
                        })
                        .catch(error => {
                            addLog(`缓存检查失败: ${error.message}`, 'error');
                            updateStepStatus(3, 'failed', `缓存检查失败: ${error.message}`);
                            resolve(false);
                        });
                }, 2000);
            });
        }
        
        // 测试激活事件
        function testActivateEvent() {
            return new Promise((resolve) => {
                updateStepStatus(4, 'running');
                addLog('测试激活事件...', 'info');
                
                if (!registration) {
                    addLog('Service Worker未注册，无法测试激活事件', 'error');
                    updateStepStatus(4, 'failed', 'Service Worker未注册');
                    resolve(false);
                    return;
                }
                
                // 监听激活事件
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'activated') {
                            addLog('Service Worker已激活!', 'success');
                            updateStepStatus(4, 'completed', '激活事件成功触发');
                            swState.textContent = '已激活';
                            resolve(true);
                        }
                    });
                });
                
                // 手动触发更新
                registration.update();
                
                // 设置超时以防激活失败
                setTimeout(() => {
                    if (registration.active && registration.active.state === 'activated') {
                        addLog('Service Worker已激活!', 'success');
                        updateStepStatus(4, 'completed', '激活事件成功触发');
                        swState.textContent = '已激活';
                        resolve(true);
                    } else {
                        addLog('Service Worker激活超时', 'error');
                        updateStepStatus(4, 'failed', '激活事件未触发');
                        resolve(false);
                    }
                }, 5000);
            });
        }
        
        // 测试请求拦截
        function testFetchEvent() {
            return new Promise((resolve) => {
                updateStepStatus(5, 'running');
                addLog('测试请求拦截...', 'info');
                
                // 模拟请求
                fetch(location.href)
                    .then(response => {
                        if (response.status === 200) {
                            addLog('请求成功拦截并处理', 'success');
                            updateStepStatus(5, 'completed', '请求拦截成功');
                            resolve(true);
                        } else {
                            addLog(`请求返回状态: ${response.status}`, 'warning');
                            updateStepStatus(5, 'completed', `请求返回状态: ${response.status}`);
                            resolve(true);
                        }
                    })
                    .catch(error => {
                        addLog(`请求失败: ${error.message}`, 'error');
                        updateStepStatus(5, 'failed', `请求失败: ${error.message}`);
                        resolve(false);
                    });
            });
        }
        
        // 测试离线功能
        function testOfflineFunctionality() {
            return new Promise((resolve) => {
                updateStepStatus(6, 'running');
                addLog('测试离线功能...', 'info');
                
                // 模拟离线环境
                isOfflineSimulated = true;
                updateUI();
                
                // 尝试获取资源
                setTimeout(() => {
                    fetch('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css')
                        .then(response => {
                            if (response.status === 200) {
                                addLog('离线资源获取成功', 'success');
                                updateStepStatus(6, 'completed', '离线资源获取成功');
                                offlineSupport.textContent = '支持';
                                offlineSupport.style.color = '#27ae60';
                                resolve(true);
                            } else {
                                addLog(`离线资源获取失败: 状态 ${response.status}`, 'warning');
                                updateStepStatus(6, 'completed', `离线资源状态: ${response.status}`);
                                offlineSupport.textContent = '部分支持';
                                offlineSupport.style.color = '#f39c12';
                                resolve(true);
                            }
                        })
                        .catch(error => {
                            addLog(`离线资源获取失败: ${error.message}`, 'error');
                            updateStepStatus(6, 'failed', `离线资源获取失败: ${error.message}`);
                            offlineSupport.textContent = '不支持';
                            offlineSupport.style.color = '#e74c3c';
                            resolve(false);
                        })
                        .finally(() => {
                            // 恢复在线状态
                            isOfflineSimulated = false;
                            updateUI();
                        });
                }, 2000);
            });
        }
        
        // 测试更新机制
        function testUpdateMechanism() {
            return new Promise((resolve) => {
                updateStepStatus(7, 'running');
                addLog('测试更新机制...', 'info');
                
                if (!registration) {
                    addLog('Service Worker未注册，无法测试更新', 'error');
                    updateStepStatus(7, 'failed', 'Service Worker未注册');
                    resolve(false);
                    return;
                }
                
                // 模拟更新
                registration.update();
                
                // 监听更新事件
                registration.addEventListener('updatefound', () => {
                    addLog('检测到Service Worker更新', 'success');
                    updateStepStatus(7, 'completed', '检测到更新');
                    updateStatus.textContent = '已更新';
                    updateStatus.style.color = '#27ae60';
                    currentVersion.textContent = 'v1.0.1';
                    resolve(true);
                });
                
                // 设置超时以防更新未触发
                setTimeout(() => {
                    addLog('未检测到更新', 'warning');
                    updateStepStatus(7, 'completed', '未检测到更新');
                    updateStatus.textContent = '无更新';
                    updateStatus.style.color = '#f39c12';
                    resolve(true);
                }, 3000);
            });
        }
        
        // 测试缓存清除
        function testCacheClear() {
            return new Promise((resolve) => {
                updateStepStatus(8, 'running');
                addLog('测试缓存清除...', 'info');
                
                caches.delete(CACHE_NAME)
                    .then(success => {
                        if (success) {
                            addLog('缓存清除成功', 'success');
                            updateStepStatus(8, 'completed', '缓存清除成功');
                            
                            // 更新UI状态
                            cacheCount.textContent = '0';
                            cacheSize.textContent = '0 KB';
                            
                            resolve(true);
                        } else {
                            addLog('缓存清除失败', 'error');
                            updateStepStatus(8, 'failed', '缓存清除失败');
                            resolve(false);
                        }
                    })
                    .catch(error => {
                        addLog(`缓存清除错误: ${error.message}`, 'error');
                        updateStepStatus(8, 'failed', `缓存清除错误: ${error.message}`);
                        resolve(false);
                    });
            });
        }
        
        // 执行单个测试
        function runSingleTest(stepIndex) {
            const step = testSteps[stepIndex];
            updateStepStatus(stepIndex, 'running');
            step.action().then(success => {
                if (success) {
                    updateStepStatus(stepIndex, 'completed');
                } else {
                    updateStepStatus(stepIndex, 'failed');
                }
            });
        }
        
        // 执行所有测试
        function runAllTests() {
            if (isTesting) return;
            
            isTesting = true;
            currentStep = 0;
            startTestBtn.disabled = true;
            addLog('开始执行全部测试...', 'info');
            
            function runNextTest() {
                if (currentStep < testSteps.length) {
                    const step = testSteps[currentStep];
                    runSingleTest(currentStep).then(() => {
                        currentStep++;
                        runNextTest();
                    });
                } else {
                    isTesting = false;
                    startTestBtn.disabled = false;
                    addLog('全部测试完成!', 'success');
                }
            }
            
            runNextTest();
        }
        
        // 重置测试
        function resetTests() {
            isTesting = false;
            currentStep = 0;
            startTestBtn.disabled = false;
            
            // 重置所有步骤状态
            testSteps.forEach((_, index) => {
                updateStepStatus(index, 'pending');
            });
            
            // 清除日志
            logContainer.innerHTML = '';
            
            // 重置UI状态
            swStatus.textContent = '未注册';
            swStatus.style.color = '#333';
            swScope.textContent = '-';
            swState.textContent = '-';
            cacheName.textContent = '-';
            cacheSize.textContent = '0 KB';
            cacheCount.textContent = '0';
            offlineSupport.textContent = '未测试';
            offlineSupport.style.color = '#333';
            currentVersion.textContent = 'v1.0.0';
            updateStatus.textContent = '未检查';
            updateStatus.style.color = '#333';
            updateProgress.textContent = '0%';
            progressFill.style.width = '0%';
            
            // 注销Service Worker并清除缓存
            if (registration) {
                registration.unregister();
                registration = null;
            }
            caches.delete(CACHE_NAME);
            
            addLog('测试已重置', 'info');
        }
        
        // 初始化
        function init() {
            initTestSteps();
            updateUI();
            
            // 添加事件监听
            startTestBtn.addEventListener('click', runAllTests);
            resetTestBtn.addEventListener('click', resetTests);
            clearCacheBtn.addEventListener('click', testCacheClear);
            clearLogsBtn.addEventListener('click', () => {
                logContainer.innerHTML = '';
                addLog('日志已清除', 'info');
            });
            simulateOfflineBtn.addEventListener('click', () => {
                isOfflineSimulated = !isOfflineSimulated;
                updateUI();
                addLog(isOfflineSimulated ? '已模拟离线环境' : '已恢复在线环境', 'info');
            });
            
            // 初始日志
            addLog('Service Worker 测试工具已初始化', 'success');
            addLog('点击"开始全部测试"按钮开始测试', 'info');
        }
        
        // 初始化应用
        init();
    </script>
</body>
</html>