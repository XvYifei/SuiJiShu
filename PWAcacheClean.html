<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4a76d0">
    <title>PWA缓存功能测试</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #4a76d0, #3a5699);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        header {
            background: #4a76d0;
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 18px;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .content {
            padding: 30px;
        }
        
        .card {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        .card h2 {
            color: #4a76d0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .card h2 i {
            font-size: 24px;
        }
        
        .test-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        @media (max-width: 600px) {
            .test-section {
                grid-template-columns: 1fr;
            }
        }
        
        .test-card {
            background: white;
            border: 1px solid #e0e7ff;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }
        
        .test-card h3 {
            color: #4a76d0;
            margin-bottom: 15px;
        }
        
        .status {
            font-size: 18px;
            font-weight: 600;
            margin: 15px 0;
            padding: 8px 16px;
            border-radius: 50px;
            display: inline-block;
        }
        
        .status.active {
            background: rgba(76, 175, 80, 0.15);
            color: #2e7d32;
        }
        
        .status.inactive {
            background: rgba(244, 67, 54, 0.15);
            color: #c62828;
        }
        
        .btn {
            display: inline-block;
            background: #4a76d0;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
            min-width: 150px;
        }
        
        .btn:hover {
            background: #3a5699;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-clear {
            background: #f44336;
        }
        
        .btn-clear:hover {
            background: #d32f2f;
        }
        
        .btn-refresh {
            background: #ff9800;
        }
        
        .btn-refresh:hover {
            background: #ef6c00;
        }
        
        .console {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 8px;
            padding: 20px;
            margin-top: 25px;
            font-family: 'Courier New', monospace;
            max-height: 200px;
            overflow-y: auto;
            line-height: 1.6;
        }
        
        .console-title {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #3498db;
            font-weight: 600;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding-left: 10px;
            border-left: 3px solid #3498db;
        }
        
        .log-entry.success {
            border-left-color: #2ecc71;
        }
        
        .log-entry.error {
            border-left-color: #e74c3c;
        }
        
        .log-entry.warning {
            border-left-color: #f39c12;
        }
        
        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin: 25px 0;
        }
        
        .instructions h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }
        
        .instructions ol {
            padding-left: 25px;
        }
        
        .instructions li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            background: #f5f5f5;
            color: #666;
            font-size: 14px;
        }
        
        .device-info {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-top: 20px;
            padding: 15px;
            background: #edf2f7;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .info-item {
            margin: 5px 10px;
        }
        /* 原有样式保持不变 */
        /* 新增样式 */
        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
            margin: 10px 5px;
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        
        .info-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-weight: 600;
            font-size: 14px;
        }
        
        .cache-details {
            background: #edf2f7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        
        .cache-details.active {
            display: block;
        }
        
        .cache-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .cache-item:last-child {
            border-bottom: none;
        }
        
        .toggle-details {
            background: none;
            border: none;
            color: #4a76d0;
            cursor: pointer;
            padding: 5px;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-mobile-alt"></i> PWA缓存功能测试</h1>
            <p class="subtitle">测试Service Worker缓存功能，验证缓存创建、读取和删除操作</p>
        </header>
        
        <div class="content">
            <div class="card">
                <h2><i class="fas fa-info-circle"></i> 测试说明</h2>
                <p>此页面用于测试您的设备对PWA缓存功能的支持情况。我们将逐步测试缓存创建、缓存状态检查和缓存删除功能。</p>
                
                <div class="instructions">
                    <h3><i class="fas fa-list-ol"></i> 测试步骤：</h3>
                    <ol>
                        <li>点击"注册Service Worker"按钮初始化缓存功能</li>
                        <li>检查缓存状态，确认缓存是否创建成功</li>
                        <li>尝试清除缓存并观察结果</li>
                        <li>刷新页面并检查缓存状态变化</li>
                        <li>查看控制台日志了解详细操作信息</li>
                    </ol>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-vial"></i> 功能测试</h2>
                
                <div class="test-section">
                    <div class="test-card">
                        <h3><i class="fas fa-plug"></i> Service Worker 状态</h3>
                        <p>当前状态: <span id="swStatus" class="status inactive">未注册</span></p>
                        <button id="registerBtn" class="btn">注册Service Worker</button>
                    </div>
                    
                    <div class="test-card">
                        <h3><i class="fas fa-database"></i> 缓存状态</h3>
                        <p>缓存状态: <span id="cacheStatus" class="status inactive">未启用</span></p>
                        <button id="checkCacheBtn" class="btn">检查缓存状态</button>
                    </div>
                    
                    <div class="test-card">
                        <h3><i class="fas fa-trash-alt"></i> 缓存管理</h3>
                        <p>操作结果: <span id="clearResult" class="status">等待操作</span></p>
                        <button id="clearCacheBtn" class="btn btn-clear">清除缓存</button>
                    </div>
                    
                    <div class="test-card">
                        <h3><i class="fas fa-sync-alt"></i> 页面操作</h3>
                        <p>刷新页面以查看缓存状态变化</p>
                        <button id="refreshBtn" class="btn btn-refresh">刷新页面</button>
                    </div>
                </div>


                <!-- 缓存详情模块 -->
                <div id="cacheDetails" class="cache-details">
                    <h3 style="color:#4a76d0; margin-bottom:15px;">缓存详情</h3>
                    <div id="cacheItems"></div>
                </div>


                
                <div class="console">
                    <div class="console-title">
                        <span>操作日志</span>
                        <span><i class="fas fa-terminal"></i></span>
                    </div>
                    <div id="logContainer"></div>
                </div>
            </div>
            
            <div class="device-info">
                <div class="info-item">
                    <span class="info-label">设备类型</span>
                    <span class="info-value" id="deviceType">检测中...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">操作系统</span>
                    <span class="info-value" id="osInfo">检测中...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">浏览器</span>
                    <span class="info-value" id="browserInfo">检测中...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">浏览器版本</span>
                    <span class="info-value" id="browserVersion">检测中...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Service Worker</span>
                    <span class="info-value" id="swSupport">检测中...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">缓存API</span>
                    <span class="info-value" id="cacheSupport">检测中...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">内存状态</span>
                    <span class="info-value" id="memoryStatus">检测中...</span>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2025 PWA缓存功能测试工具 | 用于诊断和解决PWA缓存问题</p>
        </footer>
    </div>
    
    <script>
        // DOM元素
        const registerBtn = document.getElementById('registerBtn');
        const checkCacheBtn = document.getElementById('checkCacheBtn');
        const clearCacheBtn = document.getElementById('clearCacheBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const swStatus = document.getElementById('swStatus');
        const cacheStatus = document.getElementById('cacheStatus');
        const clearResult = document.getElementById('clearResult');
        const logContainer = document.getElementById('logContainer');
        const deviceType = document.getElementById('deviceType');
        const browserInfo = document.getElementById('browserInfo');
        const swSupport = document.getElementById('swSupport');
        const cacheSupport = document.getElementById('cacheSupport');

        
        const cacheDetails = document.getElementById('cacheDetails');
        const cacheItems = document.getElementById('cacheItems');
        const osInfo = document.getElementById('osInfo');
        const browserVersion = document.getElementById('browserVersion');
        const memoryStatus = document.getElementById('memoryStatus');

        
        // 缓存名称
        const CACHE_NAME = 'pwa-cache-test-v1';
        const urlsToCache = [
            location.href,
            '/SuiJiShu/'
        ];
        
        // 添加日志
        function addLog(message, type = '') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        



        // 检测操作系统
        function detectOS() {
            const userAgent = navigator.userAgent;
            if (/Windows/.test(userAgent)) return 'Windows';
            if (/Macintosh|Mac OS X/.test(userAgent)) return 'macOS';
            if (/Linux/.test(userAgent)) return 'Linux';
            if (/Android/.test(userAgent)) return 'Android';
            if (/iOS|iPhone|iPad|iPod/.test(userAgent)) return 'iOS';
            return '未知系统';
        }
        
        // 检测浏览器详细信息
        function detectBrowser() {
            const userAgent = navigator.userAgent;
            let browser = "未知浏览器";
            let version = "未知版本";
            
            // Chrome
            if (userAgent.indexOf("Chrome") > -1 && userAgent.indexOf("Edg") === -1) {
                browser = "Chrome";
                version = userAgent.match(/Chrome\/(\d+\.\d+)/)[1];
            }
            // Edge
            else if (userAgent.indexOf("Edg") > -1) {
                browser = "Edge";
                version = userAgent.match(/Edg\/(\d+\.\d+)/)[1];
            }
            // Firefox
            else if (userAgent.indexOf("Firefox") > -1) {
                browser = "Firefox";
                version = userAgent.match(/Firefox\/(\d+\.\d+)/)[1];
            }
            // Safari
            else if (userAgent.indexOf("Safari") > -1 && userAgent.indexOf("Chrome") === -1) {
                browser = "Safari";
                version = userAgent.match(/Version\/(\d+\.\d+)/)[1];
            }
            // IE
            else if (userAgent.indexOf("Trident") > -1) {
                browser = "Internet Explorer";
                version = userAgent.match(/rv:(\d+\.\d+)/)[1];
            }
            
            return { name: browser, version: version };
        }
        
        // 检测内存状态
        function checkMemoryStatus() {
            if ('deviceMemory' in navigator) {
                return `${navigator.deviceMemory}GB`;
            } else if ('performance' in window && 'memory' in window.performance) {
                const memory = performance.memory;
                const used = Math.round(memory.usedJSHeapSize / (1024 * 1024));
                const total = Math.round(memory.totalJSHeapSize / (1024 * 1024));
                return `${used}MB/${total}MB`;
            }
            return "未知";
        }
        
        // 更新设备信息
        function updateDeviceInfo() {
            // 设备类型
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            deviceType.textContent = isMobile ? '移动设备' : '桌面设备';
            
            // 操作系统
            osInfo.textContent = detectOS();
            
            // 浏览器信息
            const browser = detectBrowser();
            browserInfo.textContent = browser.name;
            browserVersion.textContent = browser.version;
            
            // 功能支持
            swSupport.textContent = 'serviceWorker' in navigator ? '支持' : '不支持';
            swSupport.style.color = 'serviceWorker' in navigator ? '#2e7d32' : '#c62828';
            
            cacheSupport.textContent = 'caches' in window ? '支持' : '不支持';
            cacheSupport.style.color = 'caches' in window ? '#2e7d32' : '#c62828';
            
            // 内存状态
            memoryStatus.textContent = checkMemoryStatus();
        }
        
        // 获取并显示缓存内容
        async function displayCacheContent() {
            cacheItems.innerHTML = '';
            
            try {
                const cache = await caches.open(CACHE_NAME);
                const requests = await cache.keys();
                
                if (requests.length === 0) {
                    cacheItems.innerHTML = '<p>缓存中无内容</p>';
                    return;
                }
                
                requests.forEach(request => {
                    const item = document.createElement('div');
                    item.className = 'cache-item';
                    
                    const url = document.createElement('span');
                    url.textContent = request.url;
                    url.style.flex = '1';
                    url.style.overflow = 'hidden';
                    url.style.textOverflow = 'ellipsis';
                    url.style.whiteSpace = 'nowrap';
                    
                    const size = document.createElement('span');
                    size.textContent = '大小: 计算中...';
                    
                    item.appendChild(url);
                    item.appendChild(size);
                    cacheItems.appendChild(item);
                    
                    // 异步获取资源大小
                    cache.match(request).then(response => {
                        if (response) {
                            response.blob().then(blob => {
                                const kb = Math.round(blob.size / 1024);
                                size.textContent = `${kb}KB`;
                            });
                        } else {
                            size.textContent = '未知大小';
                        }
                    });
                });
                
                // 添加缓存大小总计
                const totalSize = await calculateTotalCacheSize();
                const totalItem = document.createElement('div');
                totalItem.className = 'cache-item';
                totalItem.innerHTML = `
                    <span style="font-weight:bold">总计</span>
                    <span style="font-weight:bold">${totalSize}</span>
                `;
                cacheItems.appendChild(totalItem);
                
                // 添加详情切换按钮
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'toggle-details';
                toggleBtn.textContent = '隐藏详情';
                toggleBtn.onclick = () => {
                    if (cacheDetails.classList.contains('active')) {
                        cacheDetails.classList.remove('active');
                        toggleBtn.textContent = '显示详情';
                    } else {
                        cacheDetails.classList.add('active');
                        toggleBtn.textContent = '隐藏详情';
                    }
                };
                cacheDetails.appendChild(toggleBtn);
                
            } catch (error) {
                cacheItems.innerHTML = `<p class="log-entry error">获取缓存内容失败: ${error.message}</p>`;
            }
        }
        
        // 计算缓存总大小
        async function calculateTotalCacheSize() {
            try {
                const cache = await caches.open(CACHE_NAME);
                const requests = await cache.keys();
                let totalSize = 0;
                
                for (const request of requests) {
                    const response = await cache.match(request);
                    if (response) {
                        const blob = await response.blob();
                        totalSize += blob.size;
                    }
                }
                
                if (totalSize === 0) return '0KB';
                
                if (totalSize < 1024) {
                    return `${totalSize}B`;
                } else if (totalSize < 1024 * 1024) {
                    return `${Math.round(totalSize / 1024)}KB`;
                } else {
                    return `${(totalSize / (1024 * 1024)).toFixed(2)}MB`;
                }
            } catch (error) {
                return '未知大小';
            }
        }



        
        // 注册Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw-test.js')
                    .then(registration => {
                        swStatus.textContent = '已注册';
                        swStatus.className = 'status active';
                        addLog('Service Worker 注册成功', 'success');
                        
                        // 检查是否已经激活
                        if (registration.active) {
                            addLog('Service Worker 已激活', 'success');
                        }
                        
                        // 监听激活事件
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'activated') {
                                    addLog('Service Worker 已激活', 'success');
                                    checkCacheStatus();
                                }
                            });
                        });
                        // 注册成功后显示缓存详情
                        displayCacheContent();
                    })
                    .catch(error => {
                        swStatus.textContent = '注册失败';
                        addLog(`Service Worker 注册失败: ${error.message}`, 'error');
                    });
            } else {
                swStatus.textContent = '不支持';
                addLog('当前浏览器不支持Service Worker', 'error');
            }
        }



        
        // 检查缓存状态
        function checkCacheStatus() {
            if ('caches' in window) {
                caches.has(CACHE_NAME)
                    .then(hasCache => {
                        if (hasCache) {
                            cacheStatus.textContent = '已启用';
                            cacheStatus.className = 'status active';
                            addLog('缓存存在，状态为已启用', 'success');

                            // 显示缓存详情
                            cacheDetails.classList.add('active');
                            displayCacheContent();
                        } else {
                            cacheStatus.textContent = '未启用';
                            cacheStatus.className = 'status inactive';
                            addLog('缓存不存在，状态为未启用', 'warning');
                            cacheDetails.classList.remove('active');
                        }
                    })
                    .catch(error => {
                        cacheStatus.textContent = '检测失败';
                        addLog(`缓存检测失败: ${error.message}`, 'error');
                    });
            } else {
                cacheStatus.textContent = '不支持';
                addLog('当前浏览器不支持缓存API', 'error');
            }
        }


        
        // 清除缓存
        function clearAppCache() {
            if ('caches' in window) {
                caches.delete(CACHE_NAME)
                    .then(success => {
                        if (success) {
                            clearResult.textContent = '清除成功';
                            clearResult.className = 'status active';
                            addLog('缓存清除成功', 'success');
                            
                            // 更新缓存状态显示
                            cacheStatus.textContent = '未启用';
                            cacheStatus.className = 'status inactive';

                            // 隐藏缓存详情
                            cacheDetails.classList.remove('active');
                            cacheItems.innerHTML = '';
                        } else {
                            clearResult.textContent = '清除失败';
                            clearResult.className = 'status inactive';
                            addLog('缓存清除失败: 未知错误', 'error');
                        }
                    })
                    .catch(error => {
                        clearResult.textContent = '清除失败';
                        clearResult.className = 'status inactive';
                        addLog(`缓存清除失败: ${error.message}`, 'error');
                    });
            } else {
                clearResult.textContent = '不支持';
                addLog('当前浏览器不支持缓存API', 'error');
            }
        }



            
        // 初始化页面
        function init() {
            updateDeviceInfo();
            addLog('页面初始化完成', 'success');
            
            // 检查是否有激活的Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration()
                    .then(registration => {
                        if (registration) {
                            swStatus.textContent = '已注册';
                            swStatus.className = 'status active';
                            addLog('检测到已注册的Service Worker', 'success');
                            checkCacheStatus();

                            // 显示缓存详情
                            displayCacheContent();
                        }
                    });
            }
            
            // 添加事件监听
            registerBtn.addEventListener('click', registerServiceWorker);
            checkCacheBtn.addEventListener('click', checkCacheStatus);
            clearCacheBtn.addEventListener('click', clearAppCache);
            refreshBtn.addEventListener('click', () => location.reload());
            
            // 添加缓存详情切换按钮
            const detailsToggle = document.createElement('button');
            detailsToggle.className = 'btn toggle-details';
            detailsToggle.textContent = '显示缓存详情';
            detailsToggle.style.marginTop = '15px';
            detailsToggle.onclick = () => {
                if (cacheDetails.classList.contains('active')) {
                    cacheDetails.classList.remove('active');
                    detailsToggle.textContent = '显示缓存详情';
                } else {
                    cacheDetails.classList.add('active');
                    detailsToggle.textContent = '隐藏缓存详情';
                    if (cacheStatus.textContent === '已启用') {
                        displayCacheContent();
                    }
                }
            };
            document.querySelector('.card:last-child').insertBefore(detailsToggle, console);
        }
        
        // 初始化应用
        init();
    </script>
</body>
</html>
