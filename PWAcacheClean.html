<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4a76d0">
    <title>PWA缓存功能测试 - 增强版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #4a76d0, #3a5699);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            max-width: 1000px;
            width: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        header {
            background: #4a76d0;
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }
        
        h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 18px;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .content {
            padding: 30px;
        }
        
        .card {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        .card h2 {
            color: #4a76d0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .card h2 i {
            font-size: 24px;
        }
        
        .test-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .test-section {
                grid-template-columns: 1fr;
            }
        }
        
        .test-card {
            background: white;
            border: 1px solid #e0e7ff;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }
        
        .test-card h3 {
            color: #4a76d0;
            margin-bottom: 15px;
        }
        
        .status {
            font-size: 18px;
            font-weight: 600;
            margin: 15px 0;
            padding: 8px 16px;
            border-radius: 50px;
            display: inline-block;
        }
        
        .status.active {
            background: rgba(76, 175, 80, 0.15);
            color: #2e7d32;
        }
        
        .status.inactive {
            background: rgba(244, 67, 54, 0.15);
            color: #c62828;
        }
        
        .btn {
            display: inline-block;
            background: #4a76d0;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
            min-width: 150px;
        }
        
        .btn:hover {
            background: #3a5699;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-clear {
            background: #f44336;
        }
        
        .btn-clear:hover {
            background: #d32f2f;
        }
        
        .btn-refresh {
            background: #ff9800;
        }
        
        .btn-refresh:hover {
            background: #ef6c00;
        }
        
        .console {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 8px;
            padding: 20px;
            margin-top: 25px;
            font-family: 'Courier New', monospace;
            max-height: 200px;
            overflow-y: auto;
            line-height: 1.6;
        }
        
        .console-title {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #3498db;
            font-weight: 600;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding-left: 10px;
            border-left: 3px solid #3498db;
        }
        
        .log-entry.success {
            border-left-color: #2ecc71;
        }
        
        .log-entry.error {
            border-left-color: #e74c3c;
        }
        
        .log-entry.warning {
            border-left-color: #f39c12;
        }
        
        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin: 25px 0;
        }
        
        .instructions h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }
        
        .instructions ol {
            padding-left: 25px;
        }
        
        .instructions li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            background: #f5f5f5;
            color: #666;
            font-size: 14px;
        }
        
        /* 设备信息部分增强 */
        .device-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background: #edf2f7;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .info-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .info-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }
        
        .info-item {
            margin: 8px 0;
            padding-bottom: 8px;
            border-bottom: 1px dashed #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-value {
            font-weight: 600;
        }
        
        /* 缓存信息卡片 */
        .cache-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .cache-info-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        .cache-info-card h3 {
            color: #4a76d0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #4a76d0;
            border-radius: 4px;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .online-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #2ecc71;
            margin-right: 5px;
        }
        
        .offline-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            margin-right: 5px;
        }
        
        /* 响应式调整 */
        @media (max-width: 600px) {
            .test-section {
                grid-template-columns: 1fr;
            }
            
            .device-info, .cache-info {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 26px;
            }
            
            .card h2 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-mobile-alt"></i> PWA缓存功能测试 - 增强版</h1>
            <p class="subtitle">测试Service Worker缓存功能，验证缓存创建、读取和删除操作</p>
        </header>
        
        <div class="content">
            <div class="card">
                <h2><i class="fas fa-info-circle"></i> 测试说明</h2>
                <p>此页面用于测试您的设备对PWA缓存功能的支持情况。我们将逐步测试缓存创建、缓存状态检查和缓存删除功能。</p>
                
                <div class="instructions">
                    <h3><i class="fas fa-list-ol"></i> 测试步骤：</h3>
                    <ol>
                        <li>点击"注册Service Worker"按钮初始化缓存功能</li>
                        <li>检查缓存状态，确认缓存是否创建成功</li>
                        <li>尝试清除缓存并观察结果</li>
                        <li>刷新页面并检查缓存状态变化</li>
                        <li>查看控制台日志了解详细操作信息</li>
                    </ol>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-vial"></i> 功能测试</h2>
                
                <div class="test-section">
                    <div class="test-card">
                        <h3><i class="fas fa-plug"></i> Service Worker 状态</h3>
                        <p>当前状态: <span id="swStatus" class="status inactive">未注册</span></p>
                        <button id="registerBtn" class="btn">注册Service Worker</button>
                    </div>
                    
                    <div class="test-card">
                        <h3><i class="fas fa-database"></i> 缓存状态</h3>
                        <p>缓存状态: <span id="cacheStatus" class="status inactive">未启用</span></p>
                        <button id="checkCacheBtn" class="btn">检查缓存状态</button>
                    </div>
                    
                    <div class="test-card">
                        <h3><i class="fas fa-trash-alt"></i> 缓存管理</h3>
                        <p>操作结果: <span id="clearResult" class="status">等待操作</span></p>
                        <button id="clearCacheBtn" class="btn btn-clear">清除缓存</button>
                    </div>
                    
                    <div class="test-card">
                        <h3><i class="fas fa-sync-alt"></i> 页面操作</h3>
                        <p>刷新页面以查看缓存状态变化</p>
                        <button id="refreshBtn" class="btn btn-refresh">刷新页面</button>
                    </div>
                </div>
                
                <div class="console">
                    <div class="console-title">
                        <span>操作日志</span>
                        <span><i class="fas fa-terminal"></i></span>
                    </div>
                    <div id="logContainer"></div>
                </div>
            </div>
            
            <!-- 新增缓存信息卡片 -->
            <div class="card">
                <h2><i class="fas fa-database"></i> 缓存状态信息</h2>
                <div class="cache-info">
                    <div class="cache-info-card">
                        <h3><i class="fas fa-microchip"></i> Service Worker 状态</h3>
                        <div class="info-item">
                            <span>注册状态:</span>
                            <span id="swStatusInfo" class="info-value">未注册</span>
                        </div>
                        <div class="info-item">
                            <span>作用域:</span>
                            <span id="swScope" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span>当前状态:</span>
                            <span id="swState" class="info-value">-</span>
                        </div>
                    </div>
                    
                    <div class="cache-info-card">
                        <h3><i class="fas fa-database"></i> 缓存信息</h3>
                        <div class="info-item">
                            <span>缓存名称:</span>
                            <span id="cacheName" class="info-value">pwa-cache-test-v1</span>
                        </div>
                        <div class="info-item">
                            <span>缓存大小:</span>
                            <span id="cacheSize" class="info-value">0 KB</span>
                        </div>
                        <div class="info-item">
                            <span>缓存文件数:</span>
                            <span id="cacheCount" class="info-value">0</span>
                        </div>
                    </div>
                    
                    <div class="cache-info-card">
                        <h3><i class="fas fa-network-wired"></i> 网络状态</h3>
                        <div class="info-item">
                            <span>当前状态:</span>
                            <span id="networkStatus" class="info-value">
                                <span class="online-indicator"></span> 在线
                            </span>
                        </div>
                        <div class="info-item">
                            <span>最后更新:</span>
                            <span id="lastUpdate" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span>离线支持:</span>
                            <span id="offlineSupport" class="info-value">未测试</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 增强的设备信息部分 -->
            <div class="device-info">
                <div class="info-card">
                    <h4><i class="fas fa-desktop"></i> 设备信息</h4>
                    <div class="info-item">
                        <span>设备类型:</span>
                        <span id="deviceType" class="info-value">检测中...</span>
                    </div>
                    <div class="info-item">
                        <span>操作系统:</span>
                        <span id="osInfo" class="info-value">检测中...</span>
                    </div>
                    <div class="info-item">
                        <span>屏幕尺寸:</span>
                        <span id="screenSize" class="info-value">检测中...</span>
                    </div>
                </div>
                
                <div class="info-card">
                    <h4><i class="fas fa-globe"></i> 浏览器信息</h4>
                    <div class="info-item">
                        <span>浏览器:</span>
                        <span id="browserInfo" class="info-value">检测中...</span>
                    </div>
                    <div class="info-item">
                        <span>版本:</span>
                        <span id="browserVersion" class="info-value">检测中...</span>
                    </div>
                    <div class="info-item">
                        <span>用户代理:</span>
                        <span id="userAgent" class="info-value">检测中...</span>
                    </div>
                </div>
                
                <div class="info-card">
                    <h4><i class="fas fa-cogs"></i> 功能支持</h4>
                    <div class="info-item">
                        <span>Service Worker:</span>
                        <span id="swSupport" class="info-value">检测中...</span>
                    </div>
                    <div class="info-item">
                        <span>缓存API:</span>
                        <span id="cacheSupport" class="info-value">检测中...</span>
                    </div>
                    <div class="info-item">
                        <span>HTTPS:</span>
                        <span id="httpsSupport" class="info-value">检测中...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2023 PWA缓存功能测试工具 | 用于诊断和解决PWA缓存问题</p>
            <p>增强版包含设备信息与缓存状态监控</p>
        </footer>
    </div>
    
    <script>
        // DOM元素
        const registerBtn = document.getElementById('registerBtn');
        const checkCacheBtn = document.getElementById('checkCacheBtn');
        const clearCacheBtn = document.getElementById('clearCacheBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const swStatus = document.getElementById('swStatus');
        const cacheStatus = document.getElementById('cacheStatus');
        const clearResult = document.getElementById('clearResult');
        const logContainer = document.getElementById('logContainer');
        
        // 新增元素
        const deviceType = document.getElementById('deviceType');
        const osInfo = document.getElementById('osInfo');
        const screenSize = document.getElementById('screenSize');
        const browserInfo = document.getElementById('browserInfo');
        const browserVersion = document.getElementById('browserVersion');
        const userAgent = document.getElementById('userAgent');
        const swSupport = document.getElementById('swSupport');
        const cacheSupport = document.getElementById('cacheSupport');
        const httpsSupport = document.getElementById('httpsSupport');
        const swStatusInfo = document.getElementById('swStatusInfo');
        const swScope = document.getElementById('swScope');
        const swState = document.getElementById('swState');
        const cacheName = document.getElementById('cacheName');
        const cacheSize = document.getElementById('cacheSize');
        const cacheCount = document.getElementById('cacheCount');
        const networkStatus = document.getElementById('networkStatus');
        const lastUpdate = document.getElementById('lastUpdate');
        const offlineSupport = document.getElementById('offlineSupport');
        
        // 缓存名称
        const CACHE_NAME = 'pwa-cache-test-v1';
        const urlsToCache = [
            location.href,
            '/SuiJiShu/'
        ];
        
        // 添加日志
        function addLog(message, type = '') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // 更新设备信息
        function updateDeviceInfo() {
            // 检测设备类型
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            deviceType.textContent = isMobile ? '移动设备' : '桌面设备';
            
            // 操作系统
            const osMap = {
                'Windows': /Windows NT/,
                'Mac OS': /Macintosh/,
                'Linux': /Linux/,
                'Android': /Android/,
                'iOS': /iPhone|iPad|iPod/
            };
            
            let detectedOS = '未知操作系统';
            for (const [os, regex] of Object.entries(osMap)) {
                if (regex.test(navigator.userAgent)) {
                    detectedOS = os;
                    break;
                }
            }
            osInfo.textContent = detectedOS;
            
            // 屏幕尺寸
            screenSize.textContent = `${window.screen.width} × ${window.screen.height} 像素`;
            
            // 浏览器信息
            const browserMap = {
                'Chrome': /Chrome\//,
                'Firefox': /Firefox\//,
                'Safari': /Safari\//,
                'Edge': /Edg\//,
                'Opera': /OPR\//,
                'Internet Explorer': /Trident\//
            };
            
            let detectedBrowser = '未知浏览器';
            let version = '未知版本';
            
            for (const [browser, regex] of Object.entries(browserMap)) {
                if (regex.test(navigator.userAgent)) {
                    detectedBrowser = browser;
                    const match = navigator.userAgent.match(new RegExp(`${browser}/(\\d+)`));
                    if (match && match[1]) {
                        version = match[1];
                    }
                    break;
                }
            }
            
            browserInfo.textContent = detectedBrowser;
            browserVersion.textContent = version;
            userAgent.textContent = navigator.userAgent.substring(0, 80) + '...';
            
            // 功能支持
            swSupport.textContent = 'serviceWorker' in navigator ? '支持' : '不支持';
            swSupport.style.color = 'serviceWorker' in navigator ? '#2e7d32' : '#c62828';
            
            cacheSupport.textContent = 'caches' in window ? '支持' : '不支持';
            cacheSupport.style.color = 'caches' in window ? '#2e7d32' : '#c62828';
            
            httpsSupport.textContent = window.location.protocol === 'https:' ? '是' : '否';
            httpsSupport.style.color = window.location.protocol === 'https:' ? '#2e7d32' : '#c62828';
            
            // 网络状态
            const networkEl = networkStatus.querySelector('.online-indicator, .offline-indicator');
            if (networkEl) networkEl.remove();
            
            const indicator = document.createElement('span');
            indicator.className = navigator.onLine ? 'online-indicator' : 'offline-indicator';
            networkStatus.insertBefore(indicator, networkStatus.firstChild);
            networkStatus.querySelector('.info-value').textContent = navigator.onLine ? '在线' : '离线';
            
            // 最后更新时间
            lastUpdate.textContent = new Date().toLocaleTimeString();
        }
        
        // 更新缓存信息
        async function updateCacheInfo() {
            if ('caches' in window) {
                try {
                    const cache = await caches.open(CACHE_NAME);
                    const keys = await cache.keys();
                    cacheCount.textContent = keys.length;
                    
                    let totalSize = 0;
                    for (const request of keys) {
                        const response = await cache.match(request);
                        if (response) {
                            const blob = await response.blob();
                            totalSize += blob.size;
                        }
                    }
                    
                    const sizeKB = (totalSize / 1024).toFixed(2);
                    cacheSize.textContent = `${sizeKB} KB`;
                    offlineSupport.textContent = keys.length > 0 ? '支持' : '不支持';
                    offlineSupport.style.color = keys.length > 0 ? '#2e7d32' : '#c62828';
                    
                    addLog(`缓存信息更新: ${keys.length} 个文件, ${sizeKB} KB`, 'success');
                } catch (error) {
                    cacheCount.textContent = '0';
                    cacheSize.textContent = '0 KB';
                    offlineSupport.textContent = '错误';
                    addLog(`更新缓存信息失败: ${error.message}`, 'error');
                }
            }
        }
        
        // 注册Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw-test.js')
                    .then(registration => {
                        swStatus.textContent = '已注册';
                        swStatus.className = 'status active';
                        swStatusInfo.textContent = '已注册';
                        swScope.textContent = registration.scope;
                        addLog('Service Worker 注册成功', 'success');
                        
                        // 检查是否已经激活
                        if (registration.active) {
                            swState.textContent = '已激活';
                            addLog('Service Worker 已激活', 'success');
                        }
                        
                        // 监听激活事件
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            
                            newWorker.addEventListener('statechange', () => {
                                swState.textContent = newWorker.state;
                                if (newWorker.state === 'activated') {
                                    addLog('Service Worker 已激活', 'success');
                                    checkCacheStatus();
                                }
                            });
                        });
                    })
                    .catch(error => {
                        swStatus.textContent = '注册失败';
                        swStatusInfo.textContent = '注册失败';
                        addLog(`Service Worker 注册失败: ${error.message}`, 'error');
                    });
            } else {
                swStatus.textContent = '不支持';
                swStatusInfo.textContent = '不支持';
                addLog('当前浏览器不支持Service Worker', 'error');
            }
        }
        
        // 检查缓存状态
        function checkCacheStatus() {
            if ('caches' in window) {
                caches.has(CACHE_NAME)
                    .then(hasCache => {
                        if (hasCache) {
                            cacheStatus.textContent = '已启用';
                            cacheStatus.className = 'status active';
                            addLog('缓存存在，状态为已启用', 'success');
                            updateCacheInfo();
                        } else {
                            cacheStatus.textContent = '未启用';
                            cacheStatus.className = 'status inactive';
                            addLog('缓存不存在，状态为未启用', 'warning');
                        }
                    })
                    .catch(error => {
                        cacheStatus.textContent = '检测失败';
                        addLog(`缓存检测失败: ${error.message}`, 'error');
                    });
            } else {
                cacheStatus.textContent = '不支持';
                addLog('当前浏览器不支持缓存API', 'error');
            }
        }
        
        // 清除缓存
        function clearAppCache() {
            if ('caches' in window) {
                caches.delete(CACHE_NAME)
                    .then(success => {
                        if (success) {
                            clearResult.textContent = '清除成功';
                            clearResult.className = 'status active';
                            addLog('缓存清除成功', 'success');
                            
                            // 更新缓存状态显示
                            cacheStatus.textContent = '未启用';
                            cacheStatus.className = 'status inactive';
                            
                            // 更新缓存信息
                            cacheCount.textContent = '0';
                            cacheSize.textContent = '0 KB';
                            offlineSupport.textContent = '未启用';
                        } else {
                            clearResult.textContent = '清除失败';
                            clearResult.className = 'status inactive';
                            addLog('缓存清除失败: 未知错误', 'error');
                        }
                    })
                    .catch(error => {
                        clearResult.textContent = '清除失败';
                        clearResult.className = 'status inactive';
                        addLog(`缓存清除失败: ${error.message}`, 'error');
                    });
            } else {
                clearResult.textContent = '不支持';
                addLog('当前浏览器不支持缓存API', 'error');
            }
        }
        
        // 初始化页面
        function init() {
            updateDeviceInfo();
            addLog('页面初始化完成', 'success');
            
            // 每30秒更新一次设备信息
            setInterval(updateDeviceInfo, 30000);
            
            // 检查是否有激活的Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration()
                    .then(registration => {
                        if (registration) {
                            swStatus.textContent = '已注册';
                            swStatus.className = 'status active';
                            swStatusInfo.textContent = '已注册';
                            swScope.textContent = registration.scope;
                            swState.textContent = registration.active ? '已激活' : '未激活';
                            addLog('检测到已注册的Service Worker', 'success');
                            checkCacheStatus();
                        }
                    });
            }
            
            // 添加事件监听
            registerBtn.addEventListener('click', registerServiceWorker);
            checkCacheBtn.addEventListener('click', checkCacheStatus);
            clearCacheBtn.addEventListener('click', clearAppCache);
            refreshBtn.addEventListener('click', () => location.reload());
            
            // 监听网络状态变化
            window.addEventListener('online', updateDeviceInfo);
            window.addEventListener('offline', updateDeviceInfo);
        }
        
        // 初始化应用
        init();
    </script>
</body>
</html>
